name: Deploy Discord Bot to Nomad

on:
  workflow_run:
    workflows: ["Build and Push Discord Bot"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Nomad
        run: |
          curl -L -o nomad.zip https://releases.hashicorp.com/nomad/1.9.5/nomad_1.9.5_linux_amd64.zip
          unzip nomad.zip -d nomad-temp
          sudo install -m 0755 nomad-temp/nomad /usr/local/bin/nomad
          rm -rf nomad.zip nomad-temp

      - name: Deploy Discord Bot to Nomad
        env:
          NOMAD_ADDR: http://192.168.1.17:4646
        run: |
          nomad job run \
            -var="image=192.168.1.13:5000/discord-bot:latest" \
            -var="registry_user=${{ secrets.REGISTRY_USER }}" \
            -var="registry_password=${{ secrets.REGISTRY_PASSWORD }}" \
            -var="discord_token=${{ secrets.DISCORD_TOKEN }}" \
            -var="client_id=${{ secrets.CLIENT_ID }}" \
            -var="guild_id=${{ secrets.GUILD_ID }}" \
            -var="minecraft_server_host=${{ secrets.MINECRAFT_SERVER_HOST }}" \
            -var="minecraft_server_mac=${{ secrets.MINECRAFT_SERVER_MAC }}" \
            -var="minecraft_server_port=${{ secrets.MINECRAFT_SERVER_PORT }}" \
            -var="minecraft_api_port=${{ secrets.MINECRAFT_API_PORT }}" \
            -var="minecraft_wol_wait_time=${{ secrets.MINECRAFT_WOL_WAIT_TIME }}" \
            discord-bot.nomad
